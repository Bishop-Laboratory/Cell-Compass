---
title: "Average TPM Across Time of Select Genes (GSE137001)"
author: "James Dao"
output:
  html_notebook:
    toc: true
    toc_float: true
    code_folding: hide
    theme: cerulean
---

```{r}
library(EnsDb.Hsapiens.v86)
library(DESeq2)
library(tidyverse)
library(readxl)
```


```{r}
# Download data
url <- "https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE137001&format=file&file=GSE137001%5FTPM%5Freprogramming%5Fintermediates%2Exlsx"
filename <- "GSE137001_TPM_reprogramming_intermediates.xlsx"
if (!file.exists(filename)) {
  download.file(url, filename)
}
tpms <- read_excel(filename)
```


```{r}
tpms_mat <- tpms %>% select(3:41) %>% as.matrix()

metadata <- data.frame(sample_name = colnames(tpms_mat)) %>%
  mutate(group = gsub("(d\\d+_|_R\\d)", "", sample_name)) %>%
  mutate(days = case_when(
    startsWith(sample_name, "d") ~ sub("d(\\d+).+", "\\1", sample_name),
    TRUE ~ "NA"
  )) %>%
  mutate(rep = gsub(".+R(\\d)", "\\1", sample_name)) %>%
  column_to_rownames("sample_name")
```


```{r}
# I don't think this transformation is correct
trans_mat <- log10(1 + (tpms_mat %>% t()))

pca_res <- stats::prcomp(trans_mat)

pca_df <- pca_res$x %>%
  as.data.frame() %>%
  rownames_to_column("sample_name") %>%
  mutate(group = gsub("(d\\d+_|_R\\d)", "", sample_name)) %>%
  mutate(days = case_when(
    startsWith(sample_name, "d") ~ sub("d(\\d+).+", "\\1", sample_name),
    TRUE ~ "NA"
  ))

pca_df %>%
  filter(group %in% c("SKM", "OSKM")) %>%
  ggplot(aes(
    x = PC1, y = PC2, color = days, shape = group
  )) + 
  geom_point(size = 3)
```



```{r}
# Get gene list to filter
stress_pathways <- c("GO:0036500")  # Just the ATF6 pathway
# stress_pathways <- c("GO:0009267", "GO:0034198", "GO:0036003", "GO:0036500", "GO:1990928", "GO:0034599", "GO:0034976", "GO:0016236", "GO:0010506")

gostres <- gprofiler2::gost(stress_pathways)
stress_ensg <- gostres$meta$genes_metadata$query$query_1$ensgs

ens2sym <- AnnotationDbi::select(
  EnsDb.Hsapiens.v86,
  keys = keys(EnsDb.Hsapiens.v86),
  columns = c("SYMBOL")
)

stress_genes <- ens2sym %>%
  filter(GENEID %in% stress_ensg) %>%
  pull(SYMBOL)
```


```{r}
# Filter data for selected stress genes
tpms$Name <- unlist(lapply(tpms$Name, toupper))  # Capitalize gene names
cat("% stress genes in dataset:", 100*mean(stress_genes %in% tpms$Name))

stress_tpms <- tpms %>% filter(Name %in% stress_genes)
```


```{r}
# Format data to plot
df <- stress_tpms %>%
  select(Name, contains("SKM_R")) %>%
  pivot_longer(
    contains("_"),
    names_to = c("Day", "Factors", "Rep"),
    names_pattern = "d(\\d+)_(\\w+)_R(\\d+)"
  ) %>%
  rename(log_TPM = value) %>%
  rename(Gene = Name) %>%
  mutate(log_TPM = log10(1 + log_TPM)) %>%
  mutate_if(is.character, as.factor)
```


```{r}
df %>%
  ggplot(aes(x = Day, y = log_TPM)) +
  stat_boxplot(geom ='errorbar', width = 0.5) +
  geom_boxplot() +
  facet_wrap(~Factors)
```



```{r}
res <- aov(log_TPM ~ Day, data = df %>% filter(Factors == "OSKM"))
summary(res)
```

```{r}
res <- aov(log_TPM ~ Day, data = df %>% filter(Factors == "SKM"))
summary(res)
```








